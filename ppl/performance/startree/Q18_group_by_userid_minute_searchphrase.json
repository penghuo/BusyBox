{
  "description": "Q18: SELECT UserID, extract(minute FROM EventTime) AS m, SearchPhrase, COUNT(*) FROM hits GROUP BY UserID, m, SearchPhrase ORDER BY COUNT(*) DESC LIMIT 10",
  "query": {
    "size": 0,
    "runtime_mappings": {
      "minute_of_hour": {
        "type": "long",
        "script": {
          "source": "emit(doc['EventTime'].value.getMinuteOfHour())"
        }
      }
    },
    "aggs": {
      "user_minute_search_groups": {
        "multi_terms": {
          "terms": [
            {
              "field": "UserID"
            },
            {
              "field": "minute_of_hour"
            },
            {
              "field": "SearchPhrase"
            }
          ],
          "size": 10,
          "order": {
            "_count": "desc"
          }
        }
      }
    }
  }
}
