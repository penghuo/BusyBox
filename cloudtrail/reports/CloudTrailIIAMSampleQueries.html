<!DOCTYPE html>
<html>
<head>
    <title>Presto to Spark SQL Report</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .header { background-color: #4a86e8; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .summary { margin-bottom: 20px; }
        .progress-bar { width: 100%; background-color: #f3f3f3; height: 30px; border-radius: 5px; margin-bottom: 20px; }
        .progress { height: 100%; background-color: #4CAF50; text-align: center; line-height: 30px; color: white; border-radius: 5px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f2f2f2; }
        tr:hover { background-color: #f5f5f5; }
        .success { color: green; }
        .error { color: red; }
        .query { max-width: 400px; overflow-x: auto; }
        .actions { white-space: nowrap; }
        .filter-bar { margin-bottom: 15px; }
        .tabs { display: flex; }
        .tab { padding: 5px 10px; cursor: pointer; border: 1px solid #ccc; }
        .tab.active { background-color: #4a86e8; color: white; }
        .improved { background-color: #d4edda; }
        pre { margin: 0; white-space: pre-wrap; }
        .hidden { display: none; }
        input[type=text] { padding: 5px; width: 30%; }
        button { padding: 5px 10px; margin-right: 5px; cursor: pointer; }
        
        /* Diff styling */
        .diff {
            font-family: monospace;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .diff-section { margin-bottom: 15px; }
        .diff-line { white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
        .diff-removed { background-color: #ffdddd; color: #994444; }
        .diff-added { background-color: #ddffdd; color: #449944; }
        .unchanged { color: #666; }
        .full-queries { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .error-message { white-space: pre-wrap; color: #d9534f; }
    </style>
    <script>
        function toggleQuery(id) {
            const elem = document.getElementById('query-'+id);
            elem.classList.toggle('hidden');
        }
        
        function filterStatus(status) {
            const rows = document.querySelectorAll('#resultsTable tr[data-id]');
            rows.forEach(row => {
                if (status === 'all' || 
                    (status === 'success' && row.getAttribute('data-spark') === 'true') ||
                    (status === 'failed' && row.getAttribute('data-spark') === 'false') ||
                    (status === 'improved' && row.getAttribute('data-presto') === 'false' && row.getAttribute('data-spark') === 'true')) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-'+status).classList.add('active');
        }
        
        function filterText() {
            const filter = document.getElementById('filterInput').value.toLowerCase();
            const rows = document.querySelectorAll('#resultsTable tr[data-id]');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    </script>
</head>
<body>
    <div class="header">
        <h1>Presto to Spark SQL Compatibility Report</h1>
        <p>Table: ctl_iam | Spark: 3.5.5 | Date: 2025-04-07 08:22</p>
        <p>Translation Method: Custom Rules</p>
    </div>
    
    <div class="summary">
        <p>Total queries: <b>23</b></p>
        <p>Presto success: <b>0</b> (0.0%)</p>
        <p>Spark success: <b>17</b> (73.9%)</p>
        <p>Improvement from translation: <b>17</b> queries</p>
        
        <div class="progress-bar">
            <div class="progress" style="width: 73.9%;">
                73.9%
            </div>
        </div>
    </div>
    
    <div class="filter-bar">
        <div class="tabs">
            <div id="tab-all" class="tab active" onclick="filterStatus('all')">All Queries</div>
            <div id="tab-success" class="tab" onclick="filterStatus('success')">Successful</div>
            <div id="tab-failed" class="tab" onclick="filterStatus('failed')">Failed</div>
            <div id="tab-improved" class="tab" onclick="filterStatus('improved')">Improved</div>
        </div>
        <div style="margin-top: 10px;">
            <input type="text" id="filterInput" onkeyup="filterText()" placeholder="Search...">
        </div>
    </div>
    
    <table id="resultsTable">
        <tr>
            <th>#</th>
            <th>Name</th>
            <th>Presto</th>
            <th>Spark</th>
            <th>Presto Error</th>
            <th>Spark Error</th>
            <th>Details</th>
        </tr>
    
        <tr data-id="1" data-presto="false" data-spark="true" class="improved">
            <td>1</td>
            <td>List IAM roles assumed to access services</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(1)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-1" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT eventSource, array_agg(distinct userIdentity.arn) as AssumedRoles FROM ctl_iam WHERE userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY eventSource</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT eventSource, array_agg(distinct userIdentity.arn) as AssumedRoles FROM ctl_iam WHERE userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY eventSource</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT eventSource, array_agg(distinct userIdentity.arn) as AssumedRoles FROM ctl_iam WHERE userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY eventSource
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT eventSource, array_agg(distinct userIdentity.arn) as AssumedRoles FROM ctl_iam WHERE userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY eventSource</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT eventSource, array_agg(distinct userIdentity.arn) as AssumedRoles FROM ctl_iam WHERE userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY eventSource</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="2" data-presto="false" data-spark="false" class="">
            <td>2</td>
            <td>Get actions in IAM policies</td>
            <td class="error">Failed</td>
            <td class="error">Failed</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 131)

== SQL ==
SELECT flatten(cast(transform(cast(json_extract(element_at(requestPa...</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 134)

== SQL ==
SELECT flatten(cast(transform(cast(get_json_object(element_at(reques...</td>
            <td class="actions">
                <button onclick="toggleQuery(2)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-2" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar)))) as actions FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar)))) as actions FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT flatten(cast(transform(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x 
</span>
<span class="diff-removed">
as varchar
</span>
<span class="diff-added">
AS STRING
</span>
<span class="unchanged">
)] as json))) as array(array(varchar)))) as actions FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar)))) as actions FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar)))) as actions FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="3" data-presto="false" data-spark="true" class="improved">
            <td>3</td>
            <td>Get the users who made the most failed API calls</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(3)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-3" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT userIdentity.arn as user, COUNT(*) AS error_count FROM ctl_iam WHERE errorCode IS NOT NULL AND userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn ORDER BY error_count DESC LIMIT 10</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT userIdentity.arn as user, COUNT(*) AS error_count FROM ctl_iam WHERE errorCode IS NOT NULL AND userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn ORDER BY error_count DESC LIMIT 10</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT userIdentity.arn as user, COUNT(*) AS error_count FROM ctl_iam WHERE errorCode IS NOT NULL AND userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn ORDER BY error_count DESC LIMIT 10
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT userIdentity.arn as user, COUNT(*) AS error_count FROM ctl_iam WHERE errorCode IS NOT NULL AND userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn ORDER BY error_count DESC LIMIT 10</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT userIdentity.arn as user, COUNT(*) AS error_count FROM ctl_iam WHERE errorCode IS NOT NULL AND userIdentity.arn IS NOT NULL AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn ORDER BY error_count DESC LIMIT 10</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="4" data-presto="false" data-spark="false" class="">
            <td>4</td>
            <td>Get IAM actions used in the most created IAM policies</td>
            <td class="error">Failed</td>
            <td class="error">Failed</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 202)

== SQL ==
SELECT action, count(*) as iamActionUsageCount FROM ctl_iam CROSS JO...</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 205)

== SQL ==
SELECT action, count(*) as iamActionUsageCount FROM ctl_iam CROSS JO...</td>
            <td class="actions">
                <button onclick="toggleQuery(4)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-4" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT action, count(*) as iamActionUsageCount FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY action ORDER BY iamActionUsageCount DESC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT action, count(*) as iamActionUsageCount FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY action ORDER BY iamActionUsageCount DESC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT action, count(*) as iamActionUsageCount FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x 
</span>
<span class="diff-removed">
as varchar
</span>
<span class="diff-added">
AS STRING
</span>
<span class="unchanged">
)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY action ORDER BY iamActionUsageCount DESC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT action, count(*) as iamActionUsageCount FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY action ORDER BY iamActionUsageCount DESC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT action, count(*) as iamActionUsageCount FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY action ORDER BY iamActionUsageCount DESC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="5" data-presto="false" data-spark="false" class="">
            <td>5</td>
            <td>Get AWS services used in the most created IAM policies</td>
            <td class="error">Failed</td>
            <td class="error">Failed</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 246)

== SQL ==
SELECT element_at(split(action, ':'), 1) as awsService, count(*) as ...</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 249)

== SQL ==
SELECT element_at(split(action, ':'), 1) as awsService, count(*) as ...</td>
            <td class="actions">
                <button onclick="toggleQuery(5)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-5" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT element_at(split(action, ':'), 1) as awsService, count(*) as numberOfServiceActions FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY element_at(split(action, ':'), 1) ORDER BY count(*) DESC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT element_at(split(action, ':'), 1) as awsService, count(*) as numberOfServiceActions FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY element_at(split(action, ':'), 1) ORDER BY count(*) DESC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT element_at(split(action, ':'), 1) as awsService, count(*) as numberOfServiceActions FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x 
</span>
<span class="diff-removed">
as varchar
</span>
<span class="diff-added">
AS STRING
</span>
<span class="unchanged">
)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY element_at(split(action, ':'), 1) ORDER BY count(*) DESC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT element_at(split(action, ':'), 1) as awsService, count(*) as numberOfServiceActions FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY element_at(split(action, ':'), 1) ORDER BY count(*) DESC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT element_at(split(action, ':'), 1) as awsService, count(*) as numberOfServiceActions FROM ctl_iam CROSS JOIN UNNEST(flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'iam%') AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY element_at(split(action, ':'), 1) ORDER BY count(*) DESC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="6" data-presto="false" data-spark="true" class="improved">
            <td>6</td>
            <td>Get least recently used IAM roles</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(6)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-6" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) as roleName, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource in ('sts.amazonaws.com', 'iam.amazonaws.com') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) ORDER BY lastUsage ASC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) as roleName, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource in ('sts.amazonaws.com', 'iam.amazonaws.com') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) ORDER BY lastUsage ASC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) as roleName, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource in ('sts.amazonaws.com', 'iam.amazonaws.com') AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) ORDER BY lastUsage ASC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) as roleName, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource in ('sts.amazonaws.com', 'iam.amazonaws.com') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) ORDER BY lastUsage ASC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) as roleName, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource in ('sts.amazonaws.com', 'iam.amazonaws.com') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY coalesce(element_at(requestParameters, 'roleName'), element_at(requestParameters, 'roleArn')) ORDER BY lastUsage ASC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="7" data-presto="false" data-spark="true" class="improved">
            <td>7</td>
            <td>Get least recently assumed IAM roles</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(7)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-7" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY lastUsage ASC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY lastUsage ASC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT element_at(requestParameters, 'roleArn') as roleArn, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY lastUsage ASC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY lastUsage ASC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, max(eventTime) as lastUsage FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY lastUsage ASC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="8" data-presto="false" data-spark="true" class="improved">
            <td>8</td>
            <td>Get the most frequently assumed IAM roles</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(8)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-8" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, count(*) as timesAssumed FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY timesAssumed DESC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, count(*) as timesAssumed FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY timesAssumed DESC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT element_at(requestParameters, 'roleArn') as roleArn, count(*) as timesAssumed FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY timesAssumed DESC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, count(*) as timesAssumed FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY timesAssumed DESC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT element_at(requestParameters, 'roleArn') as roleArn, count(*) as timesAssumed FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY element_at(requestParameters, 'roleArn') ORDER BY timesAssumed DESC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="9" data-presto="false" data-spark="true" class="improved">
            <td>9</td>
            <td>Investigate AssumeRole call failures</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(9)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-9" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT userIdentity.arn as callerRole, element_at(split(errorMessage, 'not authorized to perform: sts:AssumeRole on resource: '), 2) as failedToAssume FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND errorCode = 'AccessDenied' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT userIdentity.arn as callerRole, element_at(split(errorMessage, 'not authorized to perform: sts:AssumeRole on resource: '), 2) as failedToAssume FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND errorCode = 'AccessDenied' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT userIdentity.arn as callerRole, element_at(split(errorMessage, 'not authorized to perform: sts:AssumeRole on resource: '), 2) as failedToAssume FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND errorCode = 'AccessDenied' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT userIdentity.arn as callerRole, element_at(split(errorMessage, 'not authorized to perform: sts:AssumeRole on resource: '), 2) as failedToAssume FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND errorCode = 'AccessDenied' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT userIdentity.arn as callerRole, element_at(split(errorMessage, 'not authorized to perform: sts:AssumeRole on resource: '), 2) as failedToAssume FROM ctl_iam WHERE eventSource = 'sts.amazonaws.com' AND eventName = 'AssumeRole' AND errorCode = 'AccessDenied' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="10" data-presto="false" data-spark="true" class="improved">
            <td>10</td>
            <td>List users who have turned off multi-factor authentication</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(10)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-10" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId FROM ctl_iam WHERE eventSource = 'iam.amazonaws.com' AND eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId FROM ctl_iam WHERE eventSource = 'iam.amazonaws.com' AND eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId FROM ctl_iam WHERE eventSource = 'iam.amazonaws.com' AND eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId FROM ctl_iam WHERE eventSource = 'iam.amazonaws.com' AND eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId FROM ctl_iam WHERE eventSource = 'iam.amazonaws.com' AND eventName in ('DeactivateMFADevice', 'DeleteVirtualMFADevice') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId, useridentity.principalId</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="11" data-presto="false" data-spark="true" class="improved">
            <td>11</td>
            <td>List users who haven't changed their passwords recently</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(11)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-11" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, max(eventTime) as lastPasswordChange FROM ctl_iam WHERE eventName = 'ChangePassword' AND errorCode is NULL AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY lastPasswordChange ASC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, max(eventTime) as lastPasswordChange FROM ctl_iam WHERE eventName = 'ChangePassword' AND errorCode is NULL AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY lastPasswordChange ASC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, max(eventTime) as lastPasswordChange FROM ctl_iam WHERE eventName = 'ChangePassword' AND errorCode is NULL AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY lastPasswordChange ASC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, max(eventTime) as lastPasswordChange FROM ctl_iam WHERE eventName = 'ChangePassword' AND errorCode is NULL AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY lastPasswordChange ASC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, max(eventTime) as lastPasswordChange FROM ctl_iam WHERE eventName = 'ChangePassword' AND errorCode is NULL AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY lastPasswordChange ASC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="12" data-presto="false" data-spark="true" class="improved">
            <td>12</td>
            <td>Detect IAM user or role deletions</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(12)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-12" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT eventtime AS deletion_time, useridentity.username AS deleted_identity, useridentity.type AS identity_type FROM ctl_iam WHERE (eventname = 'DeleteUser' AND useridentity.type = 'IAMUser') OR (eventname = 'DeleteRole' AND useridentity.type = 'Role') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT eventtime AS deletion_time, useridentity.username AS deleted_identity, useridentity.type AS identity_type FROM ctl_iam WHERE (eventname = 'DeleteUser' AND useridentity.type = 'IAMUser') OR (eventname = 'DeleteRole' AND useridentity.type = 'Role') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT eventtime AS deletion_time, useridentity.username AS deleted_identity, useridentity.type AS identity_type FROM ctl_iam WHERE (eventname = 'DeleteUser' AND useridentity.type = 'IAMUser') OR (eventname = 'DeleteRole' AND useridentity.type = 'Role') AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT eventtime AS deletion_time, useridentity.username AS deleted_identity, useridentity.type AS identity_type FROM ctl_iam WHERE (eventname = 'DeleteUser' AND useridentity.type = 'IAMUser') OR (eventname = 'DeleteRole' AND useridentity.type = 'Role') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT eventtime AS deletion_time, useridentity.username AS deleted_identity, useridentity.type AS identity_type FROM ctl_iam WHERE (eventname = 'DeleteUser' AND useridentity.type = 'IAMUser') OR (eventname = 'DeleteRole' AND useridentity.type = 'Role') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="13" data-presto="false" data-spark="true" class="improved">
            <td>13</td>
            <td>Track assume role calls within the same account</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(13)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-13" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT * FROM ctl_iam WHERE eventName = 'AssumeRole' AND element_at(split(element_at(requestParameters, 'roleArn'), ':'), 5) = element_at(split(useridentity.arn, ':'), 5) AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT * FROM ctl_iam WHERE eventName = 'AssumeRole' AND element_at(split(element_at(requestParameters, 'roleArn'), ':'), 5) = element_at(split(useridentity.arn, ':'), 5) AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT * FROM ctl_iam WHERE eventName = 'AssumeRole' AND element_at(split(element_at(requestParameters, 'roleArn'), ':'), 5) = element_at(split(useridentity.arn, ':'), 5) AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT * FROM ctl_iam WHERE eventName = 'AssumeRole' AND element_at(split(element_at(requestParameters, 'roleArn'), ':'), 5) = element_at(split(useridentity.arn, ':'), 5) AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT * FROM ctl_iam WHERE eventName = 'AssumeRole' AND element_at(split(element_at(requestParameters, 'roleArn'), ':'), 5) = element_at(split(useridentity.arn, ':'), 5) AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="14" data-presto="false" data-spark="true" class="improved">
            <td>14</td>
            <td>Track accounts making assume role calls</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(14)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-14" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT useridentity.accountId, count(*) as numberOfAssumeRoleCalls FROM ctl_iam WHERE eventName = 'AssumeRole' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY useridentity.accountId ORDER BY numberOfAssumeRoleCalls DESC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT useridentity.accountId, count(*) as numberOfAssumeRoleCalls FROM ctl_iam WHERE eventName = 'AssumeRole' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY useridentity.accountId ORDER BY numberOfAssumeRoleCalls DESC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT useridentity.accountId, count(*) as numberOfAssumeRoleCalls FROM ctl_iam WHERE eventName = 'AssumeRole' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY useridentity.accountId ORDER BY numberOfAssumeRoleCalls DESC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT useridentity.accountId, count(*) as numberOfAssumeRoleCalls FROM ctl_iam WHERE eventName = 'AssumeRole' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY useridentity.accountId ORDER BY numberOfAssumeRoleCalls DESC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT useridentity.accountId, count(*) as numberOfAssumeRoleCalls FROM ctl_iam WHERE eventName = 'AssumeRole' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY useridentity.accountId ORDER BY numberOfAssumeRoleCalls DESC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="15" data-presto="false" data-spark="true" class="improved">
            <td>15</td>
            <td>List all IAM access key creation events</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(15)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-15" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT * FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT * FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT * FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT * FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT * FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="16" data-presto="false" data-spark="true" class="improved">
            <td>16</td>
            <td>Get users that created access keys</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(16)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-16" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, count(*) as accessKeyCreationCalls FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY accessKeyCreationCalls DESC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, count(*) as accessKeyCreationCalls FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY accessKeyCreationCalls DESC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, count(*) as accessKeyCreationCalls FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY accessKeyCreationCalls DESC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, count(*) as accessKeyCreationCalls FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY accessKeyCreationCalls DESC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT userIdentity.arn, userIdentity.userName, userIdentity.accountId, count(*) as accessKeyCreationCalls FROM ctl_iam WHERE eventName = 'CreateAccessKey' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY userIdentity.arn, userIdentity.userName, userIdentity.accountId ORDER BY accessKeyCreationCalls DESC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="17" data-presto="false" data-spark="false" class="">
            <td>17</td>
            <td>Track IAM changes that modify access to actions that can be used for privilege escalation</td>
            <td class="error">Failed</td>
            <td class="error">Failed</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 181)

== SQL ==
SELECT events.* FROM ctl_iam as events CROSS JOIN UNNEST(flatten(cas...</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'json'.(line 1, pos 184)

== SQL ==
SELECT events.* FROM ctl_iam as events CROSS JOIN UNNEST(flatten(cas...</td>
            <td class="actions">
                <button onclick="toggleQuery(17)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-17" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT events.* FROM ctl_iam as events CROSS JOIN UNNEST(flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND action IN ('iam:AddRoleToInstanceProfile', 'iam:AddUserToGroup', 'iam:AttachGroupPolicy', 'iam:AttachRolePolicy', 'iam:AttachUserPolicy', 'iam:CreateAccessKey', 'iam:CreatePolicyVersion', 'iam:CreateRole', 'iam:DeleteRolePolicy', 'iam:DeleteUserPolicy', 'iam:DetachGroupPolicy', 'iam:DetachRolePolicy', 'iam:DetachUserPolicy', 'iam:PutGroupPolicy', 'iam:PutRolePolicy', 'iam:PutUserPolicy', 'iam:RemoveUserFromGroup', 'iam:SetDefaultPolicyVersion', 'iam:UpdateUser', 'sts:AssumeRole') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) ORDER BY eventTime DESC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT events.* FROM ctl_iam as events CROSS JOIN UNNEST(flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND action IN ('iam:AddRoleToInstanceProfile', 'iam:AddUserToGroup', 'iam:AttachGroupPolicy', 'iam:AttachRolePolicy', 'iam:AttachUserPolicy', 'iam:CreateAccessKey', 'iam:CreatePolicyVersion', 'iam:CreateRole', 'iam:DeleteRolePolicy', 'iam:DeleteUserPolicy', 'iam:DetachGroupPolicy', 'iam:DetachRolePolicy', 'iam:DetachUserPolicy', 'iam:PutGroupPolicy', 'iam:PutRolePolicy', 'iam:PutUserPolicy', 'iam:RemoveUserFromGroup', 'iam:SetDefaultPolicyVersion', 'iam:UpdateUser', 'sts:AssumeRole') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) ORDER BY eventTime DESC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT events.* FROM ctl_iam as events CROSS JOIN UNNEST(flatten(cast(transform(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x 
</span>
<span class="diff-removed">
as varchar
</span>
<span class="diff-added">
AS STRING
</span>
<span class="unchanged">
)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND action IN ('iam:AddRoleToInstanceProfile', 'iam:AddUserToGroup', 'iam:AttachGroupPolicy', 'iam:AttachRolePolicy', 'iam:AttachUserPolicy', 'iam:CreateAccessKey', 'iam:CreatePolicyVersion', 'iam:CreateRole', 'iam:DeleteRolePolicy', 'iam:DeleteUserPolicy', 'iam:DetachGroupPolicy', 'iam:DetachRolePolicy', 'iam:DetachUserPolicy', 'iam:PutGroupPolicy', 'iam:PutRolePolicy', 'iam:PutUserPolicy', 'iam:RemoveUserFromGroup', 'iam:SetDefaultPolicyVersion', 'iam:UpdateUser', 'sts:AssumeRole') AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) ORDER BY eventTime DESC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT events.* FROM ctl_iam as events CROSS JOIN UNNEST(flatten(cast(transform(cast(json_extract(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x as varchar)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND action IN ('iam:AddRoleToInstanceProfile', 'iam:AddUserToGroup', 'iam:AttachGroupPolicy', 'iam:AttachRolePolicy', 'iam:AttachUserPolicy', 'iam:CreateAccessKey', 'iam:CreatePolicyVersion', 'iam:CreateRole', 'iam:DeleteRolePolicy', 'iam:DeleteUserPolicy', 'iam:DetachGroupPolicy', 'iam:DetachRolePolicy', 'iam:DetachUserPolicy', 'iam:PutGroupPolicy', 'iam:PutRolePolicy', 'iam:PutUserPolicy', 'iam:RemoveUserFromGroup', 'iam:SetDefaultPolicyVersion', 'iam:UpdateUser', 'sts:AssumeRole') AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) ORDER BY eventTime DESC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT events.* FROM ctl_iam as events CROSS JOIN UNNEST(flatten(cast(transform(cast(get_json_object(element_at(requestParameters, 'policyDocument'), '$.Statement[*].Action') as array(json)), x -> if(not try(is_json_scalar(x)), x, cast(array[cast(x AS STRING)] as json))) as array(array(varchar))))) as t (action) WHERE element_at(requestParameters, 'policyDocument') is not null AND (eventSource like 'sts%' OR eventSource like 'iam%') AND action IN ('iam:AddRoleToInstanceProfile', 'iam:AddUserToGroup', 'iam:AttachGroupPolicy', 'iam:AttachRolePolicy', 'iam:AttachUserPolicy', 'iam:CreateAccessKey', 'iam:CreatePolicyVersion', 'iam:CreateRole', 'iam:DeleteRolePolicy', 'iam:DeleteUserPolicy', 'iam:DetachGroupPolicy', 'iam:DetachRolePolicy', 'iam:DetachUserPolicy', 'iam:PutGroupPolicy', 'iam:PutRolePolicy', 'iam:PutUserPolicy', 'iam:RemoveUserFromGroup', 'iam:SetDefaultPolicyVersion', 'iam:UpdateUser', 'sts:AssumeRole') AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) ORDER BY eventTime DESC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="18" data-presto="false" data-spark="false" class="">
            <td>18</td>
            <td>Get API actions matching an IAM action-level statement</td>
            <td class="error">Failed</td>
            <td class="error">Failed</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'varchar'.(line 1, pos 239)

== SQL ==
SELECT eventId, useridentity FROM ctl_iam CROSS JOIN (VALUES '{"S...</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'varchar'.(line 1, pos 242)

== SQL ==
SELECT eventId, useridentity FROM ctl_iam CROSS JOIN (VALUES '{"S...</td>
            <td class="actions">
                <button onclick="toggleQuery(18)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-18" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT eventId, useridentity FROM ctl_iam CROSS JOIN (VALUES '{"Sid": "Statement1","Effect": "Allow","Action": ["service1:ApiName","service2:*"],"Resource": "*"}') as iam (stmt) WHERE (contains(cast(json_extract(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR contains(cast(json_extract(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':*'))) AND cast(json_extract(stmt, '$.Effect') as varchar) = 'Allow' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT eventId, useridentity FROM ctl_iam CROSS JOIN (VALUES '{"Sid": "Statement1","Effect": "Allow","Action": ["service1:ApiName","service2:*"],"Resource": "*"}') as iam (stmt) WHERE (contains(cast(get_json_object(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR contains(cast(get_json_object(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':*'))) AND cast(get_json_object(stmt, '$.Effect') AS STRING) = 'Allow' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT eventId, useridentity FROM ctl_iam CROSS JOIN (VALUES '{"Sid": "Statement1","Effect": "Allow","Action": ["service1:ApiName","service2:*"],"Resource": "*"}') as iam (stmt) WHERE (contains(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR contains(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':*'))) AND cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(stmt, '$.Effect') 
</span>
<span class="diff-removed">
as varchar
</span>
<span class="diff-added">
AS STRING
</span>
<span class="unchanged">
) = 'Allow' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT eventId, useridentity FROM ctl_iam CROSS JOIN (VALUES '{"Sid": "Statement1","Effect": "Allow","Action": ["service1:ApiName","service2:*"],"Resource": "*"}') as iam (stmt) WHERE (contains(cast(json_extract(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR contains(cast(json_extract(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':*'))) AND cast(json_extract(stmt, '$.Effect') as varchar) = 'Allow' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT eventId, useridentity FROM ctl_iam CROSS JOIN (VALUES '{"Sid": "Statement1","Effect": "Allow","Action": ["service1:ApiName","service2:*"],"Resource": "*"}') as iam (stmt) WHERE (contains(cast(get_json_object(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR contains(cast(get_json_object(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':*'))) AND cast(get_json_object(stmt, '$.Effect') AS STRING) = 'Allow' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="19" data-presto="false" data-spark="true" class="improved">
            <td>19</td>
            <td>Find AWS console logins without MFA</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(19)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-19" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT * FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT * FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT * FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT * FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT * FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="20" data-presto="false" data-spark="true" class="improved">
            <td>20</td>
            <td>Find users most frequently signing in without MFA.</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(20)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-20" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT useridentity.principalid, useridentity.username, count(*) as numberOfUserLogins FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY useridentity.principalid, useridentity.username ORDER BY numberOfUserLogins DESC</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT useridentity.principalid, useridentity.username, count(*) as numberOfUserLogins FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY useridentity.principalid, useridentity.username ORDER BY numberOfUserLogins DESC</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT useridentity.principalid, useridentity.username, count(*) as numberOfUserLogins FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP) GROUP BY useridentity.principalid, useridentity.username ORDER BY numberOfUserLogins DESC
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT useridentity.principalid, useridentity.username, count(*) as numberOfUserLogins FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP) GROUP BY useridentity.principalid, useridentity.username ORDER BY numberOfUserLogins DESC</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT useridentity.principalid, useridentity.username, count(*) as numberOfUserLogins FROM ctl_iam WHERE eventName = 'ConsoleLogin' AND cast(useridentity.sessioncontext.attributes.mfaauthenticated as boolean) = false AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP) GROUP BY useridentity.principalid, useridentity.username ORDER BY numberOfUserLogins DESC</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="21" data-presto="false" data-spark="true" class="improved">
            <td>21</td>
            <td>Get list of policies created</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(21)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-21" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT json_extract(element_at(responseElements, 'policy'), '$.policyName') as policyName, json_extract(element_at(responseElements, 'policy'), '$.arn') as policyArn FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT get_json_object(element_at(responseElements, 'policy'), '$.policyName') as policyName, get_json_object(element_at(responseElements, 'policy'), '$.arn') as policyArn FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT 
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(element_at(responseElements, 'policy'), '$.policyName') as policyName, 
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(element_at(responseElements, 'policy'), '$.arn') as policyArn FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT json_extract(element_at(responseElements, 'policy'), '$.policyName') as policyName, json_extract(element_at(responseElements, 'policy'), '$.arn') as policyArn FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT get_json_object(element_at(responseElements, 'policy'), '$.policyName') as policyName, get_json_object(element_at(responseElements, 'policy'), '$.arn') as policyArn FROM ctl_iam WHERE element_at(requestParameters, 'policyDocument') is not null AND eventName = 'CreatePolicy' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="22" data-presto="false" data-spark="true" class="improved">
            <td>22</td>
            <td>Get the list of roles with an IAM policy attached</td>
            <td class="error">Failed</td>
            <td class="success">Success</td>
            <td class="error-message">
[INVALID_PARAMETER_VALUE.DATETIME_UNIT] The value of parameter(s) `unit` in `DATE_ADD` is invalid: expects one of the units without quotes YEAR, QUAR...</td>
            <td class="error-message"></td>
            <td class="actions">
                <button onclick="toggleQuery(22)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-22" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT element_at(requestParameters,'roleName') as roleName FROM ctl_iam WHERE eventName = 'AttachRolePolicy' AND element_at(requestParameters, 'policyArn') like 'arn:aws:iam::aws:policy/%' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT element_at(requestParameters,'roleName') as roleName FROM ctl_iam WHERE eventName = 'AttachRolePolicy' AND element_at(requestParameters, 'policyArn') like 'arn:aws:iam::aws:policy/%' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT element_at(requestParameters,'roleName') as roleName FROM ctl_iam WHERE eventName = 'AttachRolePolicy' AND element_at(requestParameters, 'policyArn') like 'arn:aws:iam::aws:policy/%' AND eventTime > DATE_ADD(
</span>
<span class="diff-removed">
'week'
</span>
<span class="diff-added">
WEEK
</span>
<span class="unchanged">
, -1, CURRENT_TIMESTAMP)
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT element_at(requestParameters,'roleName') as roleName FROM ctl_iam WHERE eventName = 'AttachRolePolicy' AND element_at(requestParameters, 'policyArn') like 'arn:aws:iam::aws:policy/%' AND eventTime > DATE_ADD('week', -1, CURRENT_TIMESTAMP)</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT element_at(requestParameters,'roleName') as roleName FROM ctl_iam WHERE eventName = 'AttachRolePolicy' AND element_at(requestParameters, 'policyArn') like 'arn:aws:iam::aws:policy/%' AND eventTime > DATE_ADD(WEEK, -1, CURRENT_TIMESTAMP)</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
        <tr data-id="23" data-presto="false" data-spark="false" class="">
            <td>23</td>
            <td>Get actions for a principal affected by policy change</td>
            <td class="error">Failed</td>
            <td class="error">Failed</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'varchar'.(line 1, pos 345)

== SQL ==
SELECT eventId, userIdentity, concat(element_at(split(eventsource...</td>
            <td class="error-message">
[PARSE_SYNTAX_ERROR] Syntax error at or near 'varchar'.(line 1, pos 348)

== SQL ==
SELECT eventId, userIdentity, concat(element_at(split(eventsource...</td>
            <td class="actions">
                <button onclick="toggleQuery(23)">Show/Hide</button>
            </td>
        </tr>
        <tr id="query-23" class="hidden">
            <td colspan="6">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <h4>Presto SQL:</h4>
                        <pre>SELECT eventId, userIdentity, concat(element_at(split(eventsource, '.'), 1), ':', eventName) as iamevent, iam.stmt FROM ctl_iam CROSS JOIN (VALUES '{"Sid":"Statement1","Effect":"Allow","Action": ["exampleservice:*","anotherexampleservice:SomeAction"],"Resource": "*"}') AS iam (stmt) WHERE (contains(cast(json_extract(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR any_match(cast(json_extract(stmt, '$.Action') as array(varchar)), action -> regexp_like(concat(element_at(split(eventsource, '.'), 1), ':', eventName), concat('^', replace(replace(action, '*', '.*'), '?', '.{1}'), '$')))) AND IF(cast(json_extract(stmt, '$.Effect') as varchar) in ('Deny', 'NotAction'), errorCode is null, errorCode='AccessDenied' ) AND userIdentity.arn like '%NameOfYourPrincipal%'</pre>
                    </div>
                    <div>
                        <h4>Spark SQL:</h4>
                        <pre>SELECT eventId, userIdentity, concat(element_at(split(eventsource, '.'), 1), ':', eventName) as iamevent, iam.stmt FROM ctl_iam CROSS JOIN (VALUES '{"Sid":"Statement1","Effect":"Allow","Action": ["exampleservice:*","anotherexampleservice:SomeAction"],"Resource": "*"}') AS iam (stmt) WHERE (contains(cast(get_json_object(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR any_match(cast(get_json_object(stmt, '$.Action') as array(varchar)), action -> regexp_like(concat(element_at(split(eventsource, '.'), 1), ':', eventName), concat('^', replace(replace(action, '*', '.*'), '?', '.{1}'), '$')))) AND IF(cast(get_json_object(stmt, '$.Effect') AS STRING) in ('Deny', 'NotAction'), errorCode is null, errorCode='AccessDenied' ) AND userIdentity.arn like '%NameOfYourPrincipal%'</pre>
                    </div>
                    <div>
                        <h4>Differences:</h4>
                        <div class="diff">
<div class="diff-section"><h4>Highlighted Changes:</h4>
<div class="diff-line">
<span class="unchanged">
SELECT eventId, userIdentity, concat(element_at(split(eventsource, '.'), 1), ':', eventName) as iamevent, iam.stmt FROM ctl_iam CROSS JOIN (VALUES '{"Sid":"Statement1","Effect":"Allow","Action": ["exampleservice:*","anotherexampleservice:SomeAction"],"Resource": "*"}') AS iam (stmt) WHERE (contains(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR any_match(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(stmt, '$.Action') as array(varchar)), action -> regexp_like(concat(element_at(split(eventsource, '.'), 1), ':', eventName), concat('^', replace(replace(action, '*', '.*'), '?', '.{1}'), '$')))) AND IF(cast(
</span>
<span class="diff-removed">
json_extract
</span>
<span class="diff-added">
get_json_object
</span>
<span class="unchanged">
(stmt, '$.Effect') 
</span>
<span class="diff-removed">
as varchar
</span>
<span class="diff-added">
AS STRING
</span>
<span class="unchanged">
) in ('Deny', 'NotAction'), errorCode is null, errorCode='AccessDenied' ) AND userIdentity.arn like '%NameOfYourPrincipal%'
</span>
</div>
<div class="full-queries">
<h4>Original Presto SQL:</h4>
<pre>SELECT eventId, userIdentity, concat(element_at(split(eventsource, '.'), 1), ':', eventName) as iamevent, iam.stmt FROM ctl_iam CROSS JOIN (VALUES '{"Sid":"Statement1","Effect":"Allow","Action": ["exampleservice:*","anotherexampleservice:SomeAction"],"Resource": "*"}') AS iam (stmt) WHERE (contains(cast(json_extract(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR any_match(cast(json_extract(stmt, '$.Action') as array(varchar)), action -> regexp_like(concat(element_at(split(eventsource, '.'), 1), ':', eventName), concat('^', replace(replace(action, '*', '.*'), '?', '.{1}'), '$')))) AND IF(cast(json_extract(stmt, '$.Effect') as varchar) in ('Deny', 'NotAction'), errorCode is null, errorCode='AccessDenied' ) AND userIdentity.arn like '%NameOfYourPrincipal%'</pre>
<h4>Translated Spark SQL:</h4>
<pre>SELECT eventId, userIdentity, concat(element_at(split(eventsource, '.'), 1), ':', eventName) as iamevent, iam.stmt FROM ctl_iam CROSS JOIN (VALUES '{"Sid":"Statement1","Effect":"Allow","Action": ["exampleservice:*","anotherexampleservice:SomeAction"],"Resource": "*"}') AS iam (stmt) WHERE (contains(cast(get_json_object(stmt, '$.Action') as array(varchar)), concat(element_at(split(eventsource, '.'), 1), ':', eventName)) OR any_match(cast(get_json_object(stmt, '$.Action') as array(varchar)), action -> regexp_like(concat(element_at(split(eventsource, '.'), 1), ':', eventName), concat('^', replace(replace(action, '*', '.*'), '?', '.{1}'), '$')))) AND IF(cast(get_json_object(stmt, '$.Effect') AS STRING) in ('Deny', 'NotAction'), errorCode is null, errorCode='AccessDenied' ) AND userIdentity.arn like '%NameOfYourPrincipal%'</pre>
</div>
</div>
                    </div>
                </div>
            </td>
        </tr>
        
    </table>
</body>
</html>
    